on:
  workflow_call:

  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true

jobs:

  Deploy_Choco:
    name: Deploy WPF Chocolatey
    runs-on: windows-latest

    steps:
      - uses: actions/download-artifact@v2
        name: Download Standalone Signed App Artifacts
        with:
          name: StandaloneSigned
          path: "${{ github.workspace }}\\StandaloneSigned"

      - uses: actions/download-artifact@v3
        if: ${{ github.event_name == 'workflow_call' }}
        name: Download Signing Scripts Artifacts
        with:
          name: SigningScripts
          path: "${{ github.workspace }}/SigningScripts"

      - name: Get Version from File
        if: ${{ github.event_name == 'workflow_call' }}
        run: |
          $version = Get-Content "${{ github.workspace }}/SigningScripts/version.txt"
          echo "VERSION=$version" >> $GITHUB_ENV
        shell: powershell

      - name: Get Version from File
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          version = "${{ inputs.vERSION }}"
          echo "VERSION=$version" >> $GITHUB_ENV
        shell: powershell

      - uses: actions/download-artifact@v2
        name: Download Chocolatey Artifacts
        with:
          name: Chocolatey
          path: "${{ github.workspace }}\\Chocolatey"

      - name: Update Chocolatey Files
        run: |
          .\Build\scripts\hash-files.ps1 -Version "${{ env.VERSION }}"
        shell: powershell

      - name: Push to Chocolatey
        run: |
          .\Build\scripts\push-choco.ps1 -Version "${{ env.VERSION}}" -CHOCOAPIKEY "${{ secrets.CHOCOAPIKEY}}"
        shell: powershell
